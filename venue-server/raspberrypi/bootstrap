#!env bash

### PedalPower Bootstrap

# This script will install the necessary dependencies, code and init scripts to run a pedalpower server node.
# It should only be run on a clean raspbian image, and only need to run if your config changes

### Configuration
# Set the hostname and static ip here
# Setup logfile
local name="pedalpower-server"
local ip="10.0.0.10"
local log="bootstrap.log"

# Quit on error
set -e

_piline="------------------------------------------------------------------------------------"

# Display colorized warning output
function _error() {
    COLOR='\033[00;31m' # red
    RESET='\033[00;00m' # white
    echo -e "${COLOR}[Error] ${@}${RESET}"
    echo "Please see the log at $log for more details"
}

### Setup a logfile with the start date
touch $log
echo $_piline >> $log
date >> $log
echo $_piline >> $log

### Check that we have a network connection
ping -o -t 60 google.com >> $log || _error "can't ping google"

### Permissions
# We ask for the administrator password upfront, and update a timestamp until
# the script is finished

sudo -v
while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &

### Install software dependencies

echo -n "Installing software dependencies..."
echo -n "updating system..."
sudo aptitude update >> $log
echo -n "upgrading software..."
sudo aptitude upgrade >> $log
echo -n "installing dependencies..."
sudo aptitude install node >> $log
echo -n "installing libraries..."
npm install >> $log
echo -n "done!"

### Init scripts
# Generate the install initscripts using foreman

echo -n "Installing software dependencies..."
echo -n "installing foreman..."
gem install foreman >> $log || _error "failed installing foreman"
echo -n "creating init scripts..."
sudo foreman export upstart /  >> $log || _error "couldn't export init scripts"
echo -n "done!"

### Network config
# Each server node should have the same name and resolve to the same ip
# This is hardcoded in the software and this config script so that if a Pi
# fails, you can just pop in a new one and not miss a beat

# We do not error out on networking stuff because they produce errors
# on failed hostname lookup. That is to say, the ip and routing
# can be set fine and the ifconfig and route utilities still complain
# if the hostname is not in the router's lookup table. No big deal.

echo -n "Setting up networking..."
echo -n "setting hostname to ${name}..."
sudo hostname ${name} >> $log
echo -n "setting ip to ${ip}..."
ifconfig eth0 ${ip} netmask 255.255.255.0 >> $log
route add default gw 10.0.0.1 >> $log
echo "done!"